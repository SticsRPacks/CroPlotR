---
output: github_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# CroPlotR

<!-- badges: start -->

[![Codecov test
coverage](https://codecov.io/gh/SticsRPacks/CroPlotR/branch/master/graph/badge.svg)](https://app.codecov.io/gh/SticsRPacks/CroPlotR?branch=master)
[![R-CMD-check](https://github.com/SticsRPacks/CroPlotR/actions/workflows/check-standard.yaml/badge.svg?branch=main)](https://github.com/SticsRPacks/CroPlotR/actions/workflows/check-standard.yaml)
[![DOI](https://zenodo.org/badge/263962392.svg)](https://zenodo.org/badge/latestdoi/263962392)

<!-- badges: end -->

`CroPlotR` standardizes the analysis and visualization of crop model outputs, including models such as 
[STICS](https://www6.paca.inrae.fr/stics_eng/), [APSIM](https://www.apsim.info/), and others.

The package works seamlessly with models wrapped using the [CroptimizR](https://github.com/SticsRPacks/CroptimizR) 
package through the `cropr_simulation` data format (see [section Data structure](#13-data-structure)).

**Stay updated:** To receive notifications about new releases, click "Watch" → "Custom" → "Releases" at the top 
of [this repository](https://github.com/SticsRPacks/CroPlotR).

## Table of Contents


- [CroPlotR](#croplotr)
  - [Table of Contents](#table-of-contents)
  - [1. Installation](#1-installation)
  - [2. Introduction](#2-introduction)
  - [3. Dynamic plots](#3-dynamic-plots)
    - [3.1. Simple dynamic plot](#31-simple-dynamic-plot)
    - [3.2. Observations](#32-observations)
    - [3.3. Filter variables](#33-filter-variables)
    - [3.4. Successive situations](#34-successive-situations)
    - [3.5. Overlaying variables](#35-overlaying-variables)
  - [4. Scatter plots](#4-scatter-plots)
    - [4.1. Simple scatter plot](#41-simple-scatter-plot)
    - [4.2. Plotting residuals](#42-plotting-residuals)
    - [4.3. Grouping situations](#43-grouping-situations)
    - [4.4. Reference variable on the x-axis](#44-reference-variable-on-the-x-axis)
    - [4.5. Different shapes for situations](#45-different-shapes-for-situations)
  - [5. Comparing model versions](#5-comparing-model-versions)
  - [6. Error bars](#6-error-bars)
  - [7. Intercrops](#7-intercrops)
  - [8. Plot saving](#8-plot-saving)
  - [9. Plot extraction](#9-plot-extraction)
  - [10. Statistics](#10-statistics)
    - [10.1. Simple case](#101-simple-case)
    - [10.2. Several groups](#102-several-groups)
    - [10.3. Statistics plot](#103-statistics-plot)
  - [11. Data manipulation](#11-data-manipulation)
  - [12. Tools](#12-tools)
    - [12.1. Interactivity with ggplotly](#121-interactivity-with-ggplotly)
    - [12.2. Combining plots with patchwork](#122-combining-plots-with-patchwork)
  - [13. Data structure](#13-data-structure)
  - [14. Finding help](#14-finding-help)
  - [15. Citation](#15-citation)

## 1. Installation

Install the latest release from [GitHub](https://github.com/SticsRPacks/CroPlotR) using either `devtools` or `remotes`:

**Using `remotes` (recommended):**

```{r eval=FALSE}
# install.packages("remotes")
remotes::install_github("SticsRPacks/CroPlotR@*release")
```

**Using `devtools`:**

```{r eval=FALSE}
devtools::install_github("SticsRPacks/CroPlotR@*release")
```

## 2. Introduction

### Core Functions

CroPlotR provides two main functions:

- **[`plot()`](https://sticsrpacks.github.io/CroPlotR/reference/plot.cropr_simulation.html)** (alias: `autoplot()`) for creating visualizations
- **[`summary()`](https://sticsrpacks.github.io/CroPlotR/reference/summary.cropr_simulation.html)** for computing statistical metrics

These functions cover most visualization and analysis needs. Additional helper functions are available for data manipulation 
(see [section Data manipulation](#11-data-manipulation)).

### Using CroPlotR with Model Wrappers

If you're using a model wrapper from the [CroptimizR](https://github.com/SticsRPacks/CroptimizR) package, 
simply extract the simulations as: `sim <- result$sim_list`. For detailed examples with STICS and APSIM, 
visit [CroptimizR's documentation](https://sticsrpacks.github.io/CroptimizR/) (Articles tab).

### Example Data

The following examples use simulation and observation data from the STICS crop model:

**Sole crops** (`sim` and `obs`):
- Pea in sole crop (situation: `SC_Pea_2005-2006_N0`)
- Wheat in sole crop (situation: `SC_Wheat_2005-2006_N0`)

**Intercrop** (`sim_intercrop` and `obs_intercrop`):
- Wheat and Pea intercrop (situation: `IC_Wheat_Pea_2005-2006_N0`)

<details><summary>Click to view code for loading example data</summary>

```{r, include = FALSE}
# Importing an example with three situations with observation:
workspace <- system.file(
  file.path("extdata", "stics_example_1"),
  package = "CroPlotR"
)

situations <- SticsRFiles::get_usms_list(
  file = file.path(workspace, "usms.xml")
)

usms_sole_crop <- c("SC_Pea_2005-2006_N0", "SC_Wheat_2005-2006_N0")
usms_intercrop <- c("IC_Wheat_Pea_2005-2006_N0")

sim <- SticsRFiles::get_sim(
  workspace = workspace,
  usms_file = file.path(workspace, "usms.xml"),
  usm = usms_sole_crop
)

sim_intercrop <- SticsRFiles::get_sim(
  workspace = workspace,
  usms_file = file.path(workspace, "usms.xml"),
  usm = usms_intercrop
)

obs <- SticsRFiles::get_obs(
  workspace = workspace,
  usm = usms_sole_crop,
  usms_file = file.path(workspace, "usms.xml")
)

obs_intercrop <- SticsRFiles::get_obs(
  workspace = workspace,
  usm = usms_intercrop,
  usms_file = file.path(workspace, "usms.xml")
)

workspace_2 <- system.file(
  file.path("extdata", "stics_example_successive"),
  package = "CroPlotR"
)

situations <- SticsRFiles::get_usms_list(
  file = file.path(workspace_2, "usms.xml")
)

sim_rot <- SticsRFiles::get_sim(
  workspace = workspace_2,
  usm = situations,
  usms_file = file.path(workspace_2, "usms.xml")
)

# Generate synthetic data mimicking the output of a simulation from a newer model version (for illustration purposes)
sim2 <- sim
for (sit in names(sim2)) {
  sim2[[sit]]$lai_n <- sim[[sit]]$lai_n * 1.1
  sim2[[sit]]$masec_n <- sim[[sit]]$masec_n * 1.1
  sim2[[sit]]$mafruit <- sim[[sit]]$mafruit * 1.1
}

# Write a .RData file for reproducibility for the users
save(
  sim, sim2, sim_intercrop, obs, obs_intercrop, sim_rot,
  file = "inst/extdata/readme_sim_obs_example.RData"
)
```

```{r}
library(CroPlotR)
rdata_path <- system.file(file.path("extdata", "readme_sim_obs_example.RData"), package = "CroPlotR")
load(rdata_path)
```

</details>

## 3. Dynamic Plots

Dynamic plots show variable values over time, making them ideal for visualizing temporal patterns in crop model outputs.

### 3.1. Simple Dynamic Plot

Create basic time-series plots for all variables and situations:

```{r}
plot(sim)
```

By default, the plot function generate plots for all the variables and situations included in the data structure provided (in this example two variables, named `lai_n` and `masec_n`, and two situations, named `SC_Pea_2005-2006_N0` and `SC_Wheat_2005-2006_N0`.

### 3.2. Adding Observations

Overlay observed data on simulated outputs for model validation using the `obs` argument:

```{r}
plot(sim, obs = obs)
```

> **Note:** The `obs` argument must be explicitly named.

### 3.3. Filtering Variables

By default, all variables are plotted. Use `var` to select specific variables:

```{r}
plot(sim, obs = obs, var = c("lai_n"))
```

### 3.4. Successive Situations

Combine multiple sequential situations (e.g., crop rotations) into a single continuous timeline using the `successive` parameter:

```{r}
plot(
  sim_rot,
  var = c("resmes", "masec_n"),
  successive = list(list("demo_Wheat1", "demo_BareSoil2", "demo_maize3"))
)
```

### 3.5. Overlaying Variables

Plot multiple variables on the same graph using the `overlap` parameter:

```{r}
plot(sim, obs = obs, overlap = list(list("lai_n", "masec_n")))
```

> **Note:** Automatic variable scaling is not yet available ([see issue](https://github.com/SticsRPacks/CroPlotR/issues/2)). 
> To scale variables, transform your data before plotting and add a secondary axis using 
> [`sec_axis()`](https://ggplot2.tidyverse.org/reference/sec_axis.html).

## 4. Scatter Plots

Scatter plots compare simulated versus observed values, providing visual assessment of model performance.

### 4.1. Simple Scatter Plot

Create observed vs. simulated scatter plots by setting `type = "scatter"`:

```{r}
plots <- plot(sim, obs = obs, type = "scatter", all_situations = FALSE)
# Only displaying the first situation for this one:
plots[[1]]
```

### 4.2. Plotting Residuals

Visualize model residuals (observed - simulated values) using `select_scat = "res"`:

```{r}
plots <- plot(
  sim,
  obs = obs,
  type = "scatter",
  select_scat = "res",
  all_situations = FALSE
)
# Only displaying the first situation again, but this time using its name:
plots$`SC_Pea_2005-2006_N0`
```

### 4.3. Grouping Situations

Combine all situations in a single plot using `all_situations = TRUE`:

```{r}
plot(sim, obs = obs, type = "scatter", all_situations = TRUE)
```

### 4.4. Reference Variable on the X-axis

For residual plots, use `reference_var` to specify which variable appears on the x-axis. 
Suffix the variable name with `_obs`, `_sim` or `_res` to choose observed, simulated or residual values:

```{r}
plot(
  sim,
  obs = obs,
  type = "scatter",
  select_scat = "res",
  all_situations = TRUE,
  reference_var = "lai_n_sim"
)
```

### 4.5. Distinguishing Situations with Shapes

When plotting multiple situations together (`all_situations = TRUE`), differentiate them using the `shape_sit` parameter.

**Display situation names as text labels:**

```{r}
plot(
  sim,
  obs = obs,
  type = "scatter",
  all_situations = TRUE,
  shape_sit = "txt"
)
```

Text labels can become cluttered with many data points. Use distinct symbols instead:

```{r}
plot(
  sim,
  obs = obs,
  type = "scatter",
  all_situations = TRUE,
  shape_sit = "symbol"
)
```

**Group multiple situations under a single symbol** (e.g., for identified clusters):

```{r}
plot(
  sim,
  obs = obs,
  type = "scatter",
  all_situations = TRUE,
  shape_sit = "group",
  situation_group = list(list("SC_Pea_2005-2006_N0", "SC_Wheat_2005-2006_N0"))
)
```

**Customize legend labels** by naming your `situation_group` list:

```{r}
plot(
  sim,
  obs = obs,
  type = "scatter",
  all_situations = TRUE,
  shape_sit = "group",
  situation_group = list(
    "Two Single Crops" = list("SC_Pea_2005-2006_N0", "SC_Wheat_2005-2006_N0")
  )
)
```

## 5. Comparing Model Versions

Compare different model versions or parameter sets by passing multiple simulation objects to `plot()`. 
This is why the `obs` argument must be explicitly named.

### Dynamic Plot Comparison

```{r}
plot(sim, sim2, obs = obs, all_situations = FALSE)
```

**There is only one plot here because `sim2` contains a single situation ("SC_Wheat_2005-2006_N0").**

### Naming Model Versions

Provide descriptive names for each simulation group:

```{r}
plot(
  original = sim,
  "New version" = sim2,
  obs = obs
)
```

### Scatter Plot Comparison

Model versions can also be compared using scatter plots:

```{r}
plot(
  original = sim,
  "New version" = sim2,
  obs = obs,
  type = "scatter",
  all_situations = FALSE
)
```

## 6. Error Bars

Add uncertainty estimates to observations using the `obs_sd` parameter, which must have the same structure as `obs`. 
Error bars represent ±2 standard deviations (95% confidence interval).

The example below creates synthetic standard deviations for demonstration:

```{r}
obs_sd <- obs
names_obs <- names(obs_sd$`SC_Pea_2005-2006_N0`)
obs_sd$`SC_Pea_2005-2006_N0`[, !(names_obs %in% c("Date", "Plant"))] <-
  0.05 * obs_sd$`SC_Pea_2005-2006_N0`[, !(names_obs %in% c("Date", "Plant"))]
obs_sd$`SC_Wheat_2005-2006_N0`[, !(names_obs %in% c("Date", "Plant"))] <-
  0.2 * obs_sd$`SC_Wheat_2005-2006_N0`[, !(names_obs %in% c("Date", "Plant"))]

plot(sim, obs = obs, obs_sd = obs_sd, type = "scatter", all_situations = TRUE)
```

## 7. Intercrops

CroPlotR automatically handles intercrop situations where multiple plant species are grown together.

### Dynamic Plots for Intercrops

```{r}
plot(sim_intercrop, obs = obs_intercrop)
```

### Scatter Plots for Intercrops

```{r}
plot(sim_intercrop, obs = obs_intercrop, type = "scatter", all_situations = TRUE)
```

## 8. Saving Plots

### Save as PNG

Export individual plots as PNG files using `save_plot_png()`:

```{r eval=FALSE}
plots <- plot("New version" = sim, original = sim2, obs = obs, type = "scatter")

save_plot_png(plot = plots, out_dir = "path/to/directory", suffix = "_scatter")

# or by piping:
plots <- plot(
  "New version" = sim,
  original = sim2,
  obs = obs,
  type = "scatter"
) %>%
  save_plot_png(., out_dir = "path/to/directory", suffix = "_scatter")
```

### Save as PDF

Export plots to PDF using `save_plot_pdf()`. Set `file_per_var = TRUE` to create separate PDFs for each variable:

```{r eval=FALSE}
plots <- plot(sim, obs = obs)

save_plot_pdf(plot = plots, out_dir = "path/to/directory", file_per_var = FALSE)
```

## 9. Extracting Individual Plots

The `plot()` function returns a named list of ggplot objects, where names correspond to situations:

```{r}
p <- plot(sim)

names(p)
```

### Access by Name

Access individual plots using their situation name (use backticks if the name contains special characters):

```{r}
p$`SC_Wheat_2005-2006_N0`
```

### Access by Index

Alternatively, use numeric indexing:

```{r, eval=FALSE}
p[[1]]
```

### Filtering Plots

Use `extract_plot()` to filter plots by situation and/or variable. This is useful when working with many 
situations and variables.

Example: Extract only the wheat situation and the `masec_n` variable:

```{r}
plots <- plot(sim, obs = obs, type = "scatter", all_situations = FALSE)

extract_plot(
  plots,
  situation = c("SC_Wheat_2005-2006_N0"), var = c("masec_n")
)
```

## 10. Statistics

Compute performance metrics to quantitatively evaluate model accuracy.

### 10.1. Basic Usage

Calculate statistics for each situation individually:

```{r eval=FALSE}
summary(sim, obs = obs, all_situations = FALSE)
```

```{r echo=FALSE}
s <- summary(sim, obs = obs, all_situations = FALSE)
knitr::kable(s)
```

> **Note:** The `obs` argument must be explicitly named (same reason as for `plot()`). The warning message 
> indicates that zero-valued observations were filtered out to avoid division-by-zero errors in certain metrics.

### Aggregated Statistics

Compute statistics across all situations simultaneously:

```{r eval=FALSE}
summary(sim, obs = obs, all_situations = TRUE)
```

```{r echo=FALSE}
s <- summary(sim, obs = obs, all_situations = TRUE)
knitr::kable(s)
```

### 10.2. Comparing Multiple Groups

Compute statistics for multiple simulation groups (e.g., different model versions or parameter sets):

```{r eval=FALSE}
summary(sim, sim2, obs = obs)
```

```{r echo=FALSE}
s <- summary(sim, sim2, obs = obs)
knitr::kable(s)
```

Provide descriptive names for clarity:

```{r eval=FALSE}
summary("New version" = sim, original = sim2, obs = obs)
```

```{r echo=FALSE}
s <- summary("New version" = sim, original = sim2, obs = obs)
knitr::kable(s)
```

### Selecting Specific Statistics

By default, all available statistics are computed. Use the `stats` argument to select specific metrics:

```{r eval=FALSE}
summary(
  "New version" = sim, original = sim2, obs = obs,
  stats = c("R2", "nRMSE")
)
```

```{r echo=FALSE}
s <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("R2", "nRMSE")
)

knitr::kable(s)
```

For more details about the list of available statistical criterion and their definition, please read the help from [`predictor_assessment()`](https://sticsrpacks.github.io/CroPlotR/reference/predictor_assessment.html).

### 10.3. Visualizing Statistics

Plot statistical metrics for visual comparison using `plot()` on the summary output.

**Separate plots per situation** (`all_situations = FALSE`):

```{r}
stats <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("R2", "nRMSE"),
  all_situations = FALSE
)
plot(stats)
```

**Combined plot for all situations** (`all_situations = TRUE`):

```{r}
stats <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("R2", "nRMSE"),
  all_situations = TRUE
)

plot(stats)
```

### Customizing Plot Layout

Control which variable appears on the x-axis using the `xvar` parameter. The other variable is used for 
grouping and color coding:

```{r}
stats <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("R2", "nRMSE"),
  all_situations = FALSE
)

plot(stats, xvar = "situation", title = "Situation in X")
```

### Bar Chart Layouts

**Stacked bars** (`group_bar = "stack"`):

```{r}
stats <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("pMSEs", "pMSEu"),
  all_situations = FALSE
)

plot(stats, xvar = "situation", title = "Stacked columns", group_bar = "stack")
```

**Side-by-side bars** (`group_bar = "dodge"`):

```{r}
stats <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("pMSEs", "pMSEu"),
  all_situations = FALSE
)

plot(
  stats,
  xvar = "situation",
  title = "Side-by-side columns",
  group_bar = "dodge"
)
```

### Radar Charts

Compare model versions across multiple variables using a radar chart (`type = "radar"`) for a single metric:

```{r}
stats <- summary(
  "New version" = sim,
  original = sim2,
  obs = obs,
  stats = c("R2", "nRMSE"),
  all_situations = TRUE
)

plot(
  stats,
  type = "radar",
  crit_radar = "nRMSE",
  title = "Radar chart : nRMSE"
)
```

## 11. Data Manipulation

### Working with Standard R Packages

Observation data can be easily manipulated using packages like [dplyr](https://CRAN.R-project.org/package=dplyr), 
[tidyr](https://CRAN.R-project.org/package=tidyr), or [tibble](https://CRAN.R-project.org/package=tibble).

However, the `cropr_simulation` attribute on simulated data can interfere with some operations. CroPlotR provides 
two helper functions to facilitate data manipulation:

### Converting to Data Frame

Use `bind_rows()` to combine all situations into a single data frame:

```{r}
df <- bind_rows(sim)
head(df)
```

The `situation` column identifies the source situation for each row. This format is compatible with standard 
data manipulation packages.

### Converting Back to CroPlotR Format

After manipulation, use `split_df2sim()` to restore the original `cropr_simulation` structure:

```{r}
sim_new <- split_df2sim(df)
lapply(sim_new, head)
```

## 12. Integration with Other Packages

CroPlotR works seamlessly with popular R visualization packages to enhance your plots.

### 12.1. Interactive Plots with plotly

Convert any ggplot to an interactive visualization using `plotly::ggplotly()`:

```{r, eval = FALSE}
library(plotly)

ggplotly(plot(sim, obs = obs, type = "dynamic")[[1]])
```

### 12.2. Combining Plots with patchwork

Create complex multi-panel layouts using the [patchwork](https://CRAN.R-project.org/package=patchwork) package:

```{r}
library(patchwork)

plot1 <- plot(sim, obs = obs, type = "scatter", var = "lai_n")[[1]]
plot2 <- plot(sim, obs = obs, var = "lai_n")[[1]]
plot3 <- plot(sim, obs = obs, type = "scatter", var = "masec_n")[[1]]
plot4 <- plot(sim, obs = obs, var = "masec_n")[[1]]

plot1 + plot2 + plot3 + plot4 + plot_layout(ncol = 2)
```

## 13. Data Structure

### Understanding the `cropr_simulation` Format

Both `sim` and `obs` objects are named lists of data frames:

- **List names**: Correspond to situation identifiers (e.g., crop-year-management combinations)
- **Data frames**: Contain variable values for each situation, with one row per time step

### Simulation Data Structure

```{r}
lapply(sim, head)
```

### Observation Data Structure

Observations follow the same structure:

```{r}
lapply(obs, head)
```

### Creating Custom `cropr_simulation` Objects

You can create compatible simulation objects from your own data by adding the `cropr_simulation` class attribute 
to a named list of data frames:

```{r}
sim_test <- list(
  situation_1 = data.frame(
    Date = as.Date("2000-01-01") + 0:9,
    var1 = rnorm(10),
    var2 = rnorm(10)
  ),
  situation_2 = data.frame(
    Date = as.Date("2001-01-01") + 0:9,
    var1 = rnorm(10),
    var2 = rnorm(10)
  )
)

class(sim_test) <- append(class(sim_test), "cropr_simulation")
head(sim_test)
```

## 14. Getting Help

### Documentation

Access help for specific functions by specifying the class:

**For plotting functions:**

```{r eval=FALSE}
?plot.cropr_simulation

?plot.statistics
```

**For statistical functions:**

```{r eval=FALSE}
?summary.cropr_simulation
```

### Reporting Issues

If you encounter problems or have suggestions, please [open an issue](https://github.com/SticsRPacks/CroPlotR/issues) 
on GitHub.

## 15. Citation

If CroPlotR contributed to a publication or report, please cite it:

- **For the latest version**: Use the citation tool in the GitHub repository sidebar
- **For older versions**: Run `citation("CroPlotR")` in R to get the appropriate citation
